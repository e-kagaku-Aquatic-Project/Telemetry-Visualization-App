# パスワード認証機能設計書

## 概要
リアルタイム機体追跡Webアプリケーションへのアクセスを制限するため、パスワード認証機能を実装する。

## 要件定義

### 機能要件
1. アプリケーション起動時にログイン画面を表示
2. 正しいパスワードを入力した場合のみ、メインアプリケーションへのアクセスを許可
3. ログアウト機能の提供
4. セッション維持（ブラウザをリロードしても認証状態を保持）
5. 一定時間操作がない場合の自動ログアウト（オプション）

### 非機能要件
1. パスワードは環境変数で管理（本番環境での安全性確保）
2. 既存のアーキテクチャに最小限の変更で実装
3. ユーザビリティを損なわないシンプルなUI
4. 既存のダークテーマデザインとの統一性

## 技術選定

### 認証方式の比較

| 方式 | メリット | デメリット | 採用判定 |
|------|--------|-----------|----------|
| 環境変数による単一パスワード | シンプル、実装が容易、依存関係なし | ユーザー管理不可、パスワード変更が面倒 | ✅ 採用 |
| Firebase Auth | 本格的な認証、ユーザー管理可能 | 実装が複雑、外部依存 | ❌ |
| Auth0 | エンタープライズ対応、高機能 | コスト、実装の複雑さ | ❌ |
| カスタム認証サーバー | 完全な制御 | 開発・保守コスト大 | ❌ |

### 選定理由
- 本アプリケーションは内部利用を想定
- ユーザー数が限定的
- シンプルな実装で十分なセキュリティを確保可能
- 環境変数での管理により、デプロイ環境での柔軟な設定が可能

## アーキテクチャ設計

### コンポーネント構成

```
src/
├── components/
│   ├── auth/
│   │   ├── LoginForm.tsx        # ログインフォームコンポーネント
│   │   └── PrivateRoute.tsx     # 認証済みルートのラッパー
│   └── ...
├── hooks/
│   └── useAuth.ts               # 認証関連のカスタムフック
├── store/
│   └── index.ts                 # Zustand store（認証状態追加）
├── utils/
│   └── auth.ts                  # 認証ユーティリティ関数
└── App.tsx                      # ルート定義の更新
```

### データフロー

1. **初回アクセス時**
   ```
   User → LoginForm → useAuth → Zustand Store → localStorage
                          ↓
                    環境変数と照合
   ```

2. **認証済みアクセス時**
   ```
   User → PrivateRoute → useAuth → localStorage/Zustand Store
                              ↓
                        認証状態確認
   ```

### 状態管理

Zustand Storeに以下の状態を追加：

```typescript
interface AuthState {
  isAuthenticated: boolean;
  login: (password: string) => boolean;
  logout: () => void;
  checkAuth: () => boolean;
}
```

### セキュリティ考慮事項

1. **パスワード保護**
   - 環境変数 `VITE_APP_PASSWORD` で管理
   - ビルド時に暗号化（簡易的なハッシュ化）

2. **セッション管理**
   - localStorageにセッショントークンを保存
   - トークンは有効期限付き（24時間）
   - ブラウザ終了時の選択的クリア

3. **API保護**
   - GAS APIエンドポイントは現状のまま（公開）
   - フロントエンドレベルでの保護のみ

## UI/UXデザイン

### ログイン画面

```
┌─────────────────────────────────────────┐
│                                         │
│     リアルタイム機体追跡システム           │
│                                         │
│     ┌─────────────────────────────┐    │
│     │  パスワード                  │    │
│     └─────────────────────────────┘    │
│                                         │
│         [ ログイン ]                    │
│                                         │
│     アクセスにはパスワードが必要です      │
│                                         │
└─────────────────────────────────────────┘
```

- ダークテーマに準拠（背景: #0d1117）
- 入力フィールドは既存のスタイルを踏襲
- エラーメッセージは赤色（#f85149）で表示

### ログアウトボタン

- ヘッダー右上に配置
- アイコン: ログアウトアイコン
- ホバー時にツールチップ表示

## 実装計画

### Phase 1: 基本実装（必須）
1. 環境変数の設定
2. ログインフォームコンポーネントの作成
3. 認証状態管理（Zustand）の実装
4. PrivateRouteコンポーネントの作成
5. App.tsxでのルーティング設定

### Phase 2: UI改善（推奨）
1. ログイン画面のスタイリング
2. ローディング状態の表示
3. エラーハンドリングの改善
4. アニメーション追加（Framer Motion）

### Phase 3: 機能拡張（オプション）
1. Remember Me機能
2. 自動ログアウト機能
3. パスワード表示/非表示トグル
4. ログイン試行回数制限

## テスト計画

1. **単体テスト**
   - 認証ロジックのテスト
   - コンポーネントのレンダリングテスト

2. **統合テスト**
   - ログインフローのE2Eテスト
   - セッション維持のテスト
   - ログアウト機能のテスト

3. **セキュリティテスト**
   - 不正アクセスの防止確認
   - セッション有効期限の動作確認

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| パスワード漏洩 | 高 | 環境変数での管理、定期的な変更 |
| セッション固定化攻撃 | 中 | ログイン時のトークン再生成 |
| ブルートフォース攻撃 | 低 | ログイン試行回数制限（Phase 3） |

## 今後の拡張可能性

1. **ユーザー管理機能**
   - 複数ユーザー対応
   - 権限管理

2. **二要素認証**
   - TOTP対応
   - SMS認証

3. **SSO連携**
   - Google Workspace連携
   - Azure AD連携

## 結論

環境変数による単一パスワード認証は、本アプリケーションの要件に対して最適なソリューションである。シンプルな実装により、開発コストを抑えつつ、必要十分なセキュリティを確保できる。