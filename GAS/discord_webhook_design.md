# Discord WebHook‰ø°Âè∑„É≠„Çπ„ÉàÈÄöÁü•Ê©üËÉΩ Ë©≥Á¥∞Ë®≠Ë®àÊõ∏

## 1. „Ç∑„Çπ„ÉÜ„É†ÊßãÊàê

### 1.1 „Éï„Ç°„Ç§„É´ÊßãÊàê
GAS„Ç≥„Éº„Éâ„Çí‰ª•‰∏ã„ÅÆË§áÊï∞„Éï„Ç°„Ç§„É´„Å´ÂàÜÂâ≤„Åó„Å¶ÁÆ°ÁêÜ„Åô„ÇãÔºö

```
Google Apps Script „Éó„É≠„Ç∏„Çß„ÇØ„Éà/
‚îú‚îÄ‚îÄ Main.gs                    # „É°„Ç§„É≥„Ç®„É≥„Éà„É™„Éº„Éù„Ç§„É≥„ÉàÔºàdoGet, doPostÔºâ
‚îú‚îÄ‚îÄ DataManager.gs             # „Éá„Éº„Çø‰øùÂ≠ò„ÉªÂèñÂæóÈñ¢ÈÄ£
‚îú‚îÄ‚îÄ WebhookNotification.gs     # Discord WebHookÈÄöÁü•Èñ¢ÈÄ£
‚îú‚îÄ‚îÄ MachineMonitor.gs          # Ê©ü‰ΩìÁõ£Ë¶ñ„ÉªÁä∂ÊÖãÁÆ°ÁêÜ
‚îú‚îÄ‚îÄ Utils.gs                   # „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
‚îî‚îÄ‚îÄ Config.gs                  # Ë®≠ÂÆöÁÆ°ÁêÜ
```

### 1.2 „Éá„Éº„ÇøÊßãÈÄ†

#### 1.2.1 „Ç∑„Éº„Éà„Éò„ÉÉ„ÉÄ„ÉºÊã°Âºµ
Êó¢Â≠ò„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„Å´KÂàó„ÇíËøΩÂä†„Åó„ÄÅK1„Çª„É´„ÅßÊ©ü‰Ωì„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÁÆ°ÁêÜÔºö
```javascript
const headers = [
  "GAS Time",          // AÂàó
  "MachineTime",       // BÂàó
  "MachineID",         // CÂàó
  "DataType",          // DÂàó
  "Latitude",          // EÂàó
  "Longitude",         // FÂàó
  "Altitude",          // GÂàó
  "GPS Satellites",    // HÂàó
  "Battery",           // IÂàó
  "Comment",           // JÂàó
  "IsActive"           // KÂàóÔºàK1„Çª„É´„ÅßÊ©ü‰ΩìÁä∂ÊÖãÁÆ°ÁêÜÔºâ
];
```

**ÈáçË¶Å**: K1„Çª„É´Ôºà1Ë°åÁõÆ„ÅÆKÂàóÔºâ„ÅÆ„Åø„ÅåÊ©ü‰Ωì„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÁ§∫„Åó„ÄÅ„Éá„Éº„ÇøË°åÔºà2Ë°åÁõÆ‰ª•ÈôçÔºâ„ÅÆKÂàó„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ„ÄÇ

#### 1.2.2 Ê©ü‰ΩìÁõ£Ë¶ñÁä∂ÊÖãÁÆ°ÁêÜÁî®„Ç∑„Éº„Éà
Êñ∞Ë¶è„Ç∑„Éº„Éà„Äå_MachineMonitorStatus„Äç„ÇíËøΩÂä†„Åó„Å¶Áõ£Ë¶ñÁä∂ÊÖã„ÇíÁÆ°ÁêÜÔºö
```
| MachineID | LastNotified | NotificationStatus | LastDataReceived | NotificationCount | FirstLostTime |
|-----------|--------------|-------------------|------------------|-------------------|---------------|
| 00453     | 2025-07-24...| lost              | 2025-07-24...    | 3                 | 2025-07-24...|
| 00454     | null         | normal            | 2025-07-24...    | 0                 | null          |
```

**ËøΩÂä†„Éï„Ç£„Éº„É´„Éâ**:
- `NotificationCount`: ÈÄÅ‰ø°„Åó„ÅüÈÄöÁü•ÂõûÊï∞
- `FirstLostTime`: ÂàùÂõû„É≠„Çπ„ÉàÊ§úÁü•ÊôÇÂàª

### 1.3 Discord WebHook‰ªïÊßò

#### 1.3.1 ÈÄöÁü•ÂΩ¢Âºè
Discord Embed„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Çí‰ΩøÁî®ÔºàÂÖ®„Å¶Ëã±Ë™ûÔºâÔºö
```javascript
{
  "embeds": [{
    "title": "üö® Machine Signal Lost",
    "description": `Signal from machine ${machineId} has been lost`,
    "color": 15158332,  // Red color
    "fields": [
      {
        "name": "Machine ID",
        "value": machineId,
        "inline": true
      },
      {
        "name": "Last Data Received",
        "value": lastDataReceived,
        "inline": true
      },
      {
        "name": "Last Position",
        "value": `Lat: ${lat}\nLng: ${lng}\nAlt: ${alt}m`,
        "inline": false
      },
      {
        "name": "Battery",
        "value": `${battery}V`,
        "inline": true
      },
      {
        "name": "GPS Satellites",
        "value": satellites,
        "inline": true
      }
    ],
    "timestamp": new Date().toISOString(),
    "footer": {
      "text": "Telemetry Monitoring System"
    }
  }]
}
```

## 2. Ê©üËÉΩË©≥Á¥∞Ë®≠Ë®à

### 2.1 Config.gs - Ë®≠ÂÆöÁÆ°ÁêÜ

```javascript
// „Çπ„ÇØ„É™„Éó„Éà„Éó„É≠„Éë„ÉÜ„Ç£„Åã„ÇâË®≠ÂÆö„ÇíÂèñÂæó
const CONFIG = {
  DISCORD_WEBHOOK_URL: getScriptProperty('DISCORD_WEBHOOK_URL'),
  TIMEOUT_MINUTES: parseInt(getScriptProperty('TIMEOUT_MINUTES') || '10'),
  CHECK_INTERVAL_MINUTES: parseInt(getScriptProperty('CHECK_INTERVAL_MINUTES') || '1'),
  REMINDER_INTERVAL_MINUTES: parseInt(getScriptProperty('REMINDER_INTERVAL_MINUTES') || '10'),
  ENABLE_NOTIFICATIONS: getScriptProperty('ENABLE_NOTIFICATIONS') === 'true',
  MAX_RETRY_COUNT: 3,
  RETRY_DELAY_MS: 1000
};

function getScriptProperty(key) {
  return PropertiesService.getScriptProperties().getProperty(key);
}

function setScriptProperty(key, value) {
  PropertiesService.getScriptProperties().setProperty(key, value);
}
```

### 2.2 MachineMonitor.gs - Ê©ü‰ΩìÁõ£Ë¶ñÊ©üËÉΩ

```javascript
/**
 * ÂÆöÊúüÁõ£Ë¶ñ„Éà„É™„Ç¨„ÉºÈñ¢Êï∞Ôºà1ÂàÜÊØé„Å´ÂÆüË°åÔºâ
 */
function checkMachineSignals() {
  if (!CONFIG.ENABLE_NOTIFICATIONS) {
    console.log('Notification system is disabled');
    return;
  }
  
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  const activeMachines = getActiveMachines(spreadsheet);
  const monitorStatus = getMonitorStatus(spreadsheet);
  
  activeMachines.forEach(machine => {
    checkMachineTimeout(machine, monitorStatus);
  });
  
  updateMonitorStatus(spreadsheet, monitorStatus);
}

/**
 * „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê©ü‰Ωì„É™„Çπ„Éà„ÇíÂèñÂæó
 */
function getActiveMachines(spreadsheet) {
  const sheets = spreadsheet.getSheets();
  const activeMachines = [];
  
  sheets.forEach(sheet => {
    const sheetName = sheet.getName();
    if (sheetName.startsWith('Machine_')) {
      const machineId = sheetName.replace('Machine_', '');
      
      // K1„Çª„É´Ôºà1Ë°åÁõÆKÂàóÔºâ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éï„É©„Ç∞„ÇíÁ¢∫Ë™ç
      const isActive = sheet.getRange(1, 11).getValue();
      if (isActive === true || isActive === 'TRUE') {
        const lastRow = sheet.getLastRow();
        if (lastRow > 1) {
          const lastDataTime = sheet.getRange(lastRow, 1).getValue();
          const lastData = sheet.getRange(lastRow, 1, 1, 10).getValues()[0];
          
          activeMachines.push({
            machineId: machineId,
            sheet: sheet,
            lastDataTime: lastDataTime,
            lastData: lastData
          });
        }
      }
    }
  });
  
  return activeMachines;
}

/**
 * „Çø„Ç§„É†„Ç¢„Ç¶„Éà„ÉÅ„Çß„ÉÉ„ÇØ
 */
function checkMachineTimeout(machine, monitorStatus) {
  const now = new Date();
  const lastDataTime = new Date(machine.lastDataTime);
  const diffMinutes = (now - lastDataTime) / (1000 * 60);
  
  const currentStatus = monitorStatus[machine.machineId] || { 
    status: 'normal', 
    notificationCount: 0,
    firstLostTime: null
  };
  
  if (diffMinutes >= CONFIG.TIMEOUT_MINUTES) {
    // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÊ§úÂá∫
    if (currentStatus.status !== 'lost') {
      // Êñ∞Ë¶è„É≠„Çπ„ÉàÊ§úÂá∫ - ÂàùÂõûÈÄöÁü•ÈÄÅ‰ø°
      sendLostNotification(machine, 1, diffMinutes);
      monitorStatus[machine.machineId] = {
        status: 'lost',
        lastNotified: now.toISOString(),
        lastDataReceived: lastDataTime.toISOString(),
        notificationCount: 1,
        firstLostTime: now.toISOString()
      };
    } else {
      // Á∂ôÁ∂ö„É≠„Çπ„Éà - „É™„Éû„Ç§„É≥„ÉÄ„ÉºÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØ
      const lastNotified = new Date(currentStatus.lastNotified);
      const minutesSinceLastNotification = (now - lastNotified) / (1000 * 60);
      
      if (minutesSinceLastNotification >= CONFIG.REMINDER_INTERVAL_MINUTES) {
        // „É™„Éû„Ç§„É≥„ÉÄ„ÉºÈÄöÁü•ÈÄÅ‰ø°
        const notificationCount = currentStatus.notificationCount + 1;
        sendLostReminderNotification(machine, notificationCount, diffMinutes);
        monitorStatus[machine.machineId] = {
          ...currentStatus,
          lastNotified: now.toISOString(),
          notificationCount: notificationCount
        };
      }
    }
  } else {
    // Ê≠£Â∏∏ÈÄö‰ø°
    if (currentStatus.status === 'lost') {
      // Âæ©Â∏∞Ê§úÂá∫ - Âæ©Â∏∞ÈÄöÁü•ÈÄÅ‰ø°
      const lostDuration = (now - new Date(currentStatus.firstLostTime)) / (1000 * 60);
      sendRecoveryNotification(machine, currentStatus.notificationCount, lostDuration);
      monitorStatus[machine.machineId] = {
        status: 'normal',
        lastNotified: now.toISOString(),
        lastDataReceived: lastDataTime.toISOString(),
        notificationCount: 0,
        firstLostTime: null
      };
    }
  }
}
```

### 2.3 WebhookNotification.gs - DiscordÈÄöÁü•Ê©üËÉΩ

```javascript
/**
 * Send signal lost notification (initial)
 */
function sendLostNotification(machine, notificationCount, lostDurationMinutes) {
  const lastData = machine.lastData;
  const embed = {
    title: "üö® Machine Signal Lost",
    description: `Signal from machine ${machine.machineId} has been lost`,
    color: 15158332, // Red color
    fields: [
      {
        name: "Machine ID",
        value: machine.machineId,
        inline: true
      },
      {
        name: "Last Data Received",
        value: formatDateTimeJST(machine.lastDataTime),
        inline: true
      },
      {
        name: "Duration Lost",
        value: `${Math.floor(lostDurationMinutes)} minutes`,
        inline: true
      },
      {
        name: "Last Position",
        value: `Lat: ${lastData[4]}\nLng: ${lastData[5]}\nAlt: ${lastData[6]}m`,
        inline: false
      },
      {
        name: "Battery",
        value: `${lastData[8]}V`,
        inline: true
      },
      {
        name: "GPS Satellites",
        value: lastData[7].toString(),
        inline: true
      }
    ],
    timestamp: new Date().toISOString(),
    footer: {
      "text": "Telemetry Monitoring System"
    }
  };
  
  if (lastData[9]) {
    embed.fields.push({
      name: "Last Comment",
      value: lastData[9],
      inline: false
    });
  }
  
  sendDiscordNotification({ embeds: [embed] });
}

/**
 * Send signal lost reminder notification (every 10 minutes)
 */
function sendLostReminderNotification(machine, notificationCount, lostDurationMinutes) {
  const lastData = machine.lastData;
  const embed = {
    title: "‚ö†Ô∏è Machine Signal Lost Continues",
    description: `Machine ${machine.machineId} signal loss continues (notification #${notificationCount})`,
    color: 16753920, // Orange color
    fields: [
      {
        name: "Machine ID",
        value: machine.machineId,
        inline: true
      },
      {
        name: "Lost Duration",
        value: `${Math.floor(lostDurationMinutes)} minutes`,
        inline: true
      },
      {
        name: "Notification Count",
        value: `#${notificationCount}`,
        inline: true
      },
      {
        name: "Last Data Received",
        value: formatDateTimeJST(machine.lastDataTime),
        inline: true
      },
      {
        name: "Last Position",
        value: `Lat: ${lastData[4]}\nLng: ${lastData[5]}`,
        inline: true
      },
      {
        name: "Last Battery",
        value: `${lastData[8]}V`,
        inline: true
      }
    ],
    timestamp: new Date().toISOString(),
    footer: {
      "text": "Telemetry Monitoring System - Reminder"
    }
  };
  
  sendDiscordNotification({ embeds: [embed] });
}

/**
 * Send signal recovery notification
 */
function sendRecoveryNotification(machine, totalNotificationCount, totalLostDurationMinutes) {
  const embed = {
    title: "‚úÖ Machine Signal Recovered",
    description: `Machine ${machine.machineId} communication has been restored`,
    color: 3066993, // Green color
    fields: [
      {
        name: "Machine ID",
        value: machine.machineId,
        inline: true
      },
      {
        name: "Recovery Time",
        value: formatDateTimeJST(machine.lastDataTime),
        inline: true
      },
      {
        name: "Total Lost Duration",
        value: `${Math.floor(totalLostDurationMinutes)} minutes`,
        inline: true
      },
      {
        name: "Total Notifications Sent",
        value: `${totalNotificationCount} times`,
        inline: true
      }
    ],
    timestamp: new Date().toISOString(),
    footer: {
      "text": "Telemetry Monitoring System"
    }
  };
  
  sendDiscordNotification({ embeds: [embed] });
}

/**
 * Send Discord WebHook notification
 */
function sendDiscordNotification(payload) {
  if (!CONFIG.DISCORD_WEBHOOK_URL) {
    console.error('Discord WebHook URL is not configured');
    return;
  }
  
  let retryCount = 0;
  while (retryCount < CONFIG.MAX_RETRY_COUNT) {
    try {
      const response = UrlFetchApp.fetch(CONFIG.DISCORD_WEBHOOK_URL, {
        method: 'post',
        contentType: 'application/json',
        payload: JSON.stringify(payload)
      });
      
      if (response.getResponseCode() === 204) {
        console.log('Discord notification sent successfully');
        return;
      }
    } catch (error) {
      console.error(`Discord notification error (attempt ${retryCount + 1}/${CONFIG.MAX_RETRY_COUNT}):`, error);
      retryCount++;
      
      if (retryCount < CONFIG.MAX_RETRY_COUNT) {
        Utilities.sleep(CONFIG.RETRY_DELAY_MS);
      }
    }
  }
  
  console.error('Failed to send Discord notification (max retries reached)');
}
```

### 2.4 DataManager.gs - „Éá„Éº„ÇøÁÆ°ÁêÜÊ©üËÉΩ„ÅÆÊã°Âºµ

Êó¢Â≠ò„ÅÆcreateNewSheetÈñ¢Êï∞„Çí‰øÆÊ≠£Ôºö
```javascript
function createNewSheet(spreadsheet, sheetName) {
  const sheet = spreadsheet.insertSheet(sheetName);
  
  const headers = [
    "GAS Time",
    "MachineTime",
    "MachineID",
    "DataType",
    "Latitude",
    "Longitude",
    "Altitude",
    "GPS Satellites",
    "Battery",
    "Comment",
    "IsActive"  // KÂàóËøΩÂä†
  ];
  
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // „Éò„ÉÉ„ÉÄ„ÉºË°å„ÅÆÊõ∏ÂºèË®≠ÂÆö
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setBackground("#4285f4");
  headerRange.setFontColor("white");
  headerRange.setFontWeight("bold");
  
  // K1„Çª„É´ÔºàIsActiveÔºâ„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíTRUE„Å´Ë®≠ÂÆö
  sheet.getRange(1, 11).setValue(true);
  
  // K1„Çª„É´„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíË®≠ÂÆö
  const activeColumnRange = sheet.getRange(1, 11);
  activeColumnRange.insertCheckboxes();
  
  sheet.autoResizeColumns(1, headers.length);
  sheet.setFrozenRows(1);
  
  return sheet;
}
```

### 2.5 Utils.gs - „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞

```javascript
/**
 * Êó•Êú¨ÊôÇÈñì„Åß„Éï„Ç©„Éº„Éû„ÉÉ„Éà
 */
function formatDateTimeJST(date) {
  if (!(date instanceof Date)) {
    date = new Date(date);
  }
  return Utilities.formatDate(date, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss");
}

/**
 * Áõ£Ë¶ñÁä∂ÊÖã„Ç∑„Éº„Éà„ÅÆÂèñÂæó„Éª‰ΩúÊàê
 */
function getOrCreateMonitorSheet(spreadsheet) {
  const sheetName = '_MachineMonitorStatus';
  let sheet = spreadsheet.getSheetByName(sheetName);
  
  if (!sheet) {
    sheet = spreadsheet.insertSheet(sheetName);
    const headers = [
      'MachineID', 'LastNotified', 'NotificationStatus', 
      'LastDataReceived', 'NotificationCount', 'FirstLostTime'
    ];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // „Éò„ÉÉ„ÉÄ„ÉºË£ÖÈ£æ
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setBackground("#666666");
    headerRange.setFontColor("white");
    headerRange.setFontWeight("bold");
    
    sheet.setFrozenRows(1);
    sheet.autoResizeColumns(1, headers.length);
  }
  
  return sheet;
}

/**
 * Áõ£Ë¶ñÁä∂ÊÖã„ÅÆË™≠„ÅøËæº„Åø
 */
function getMonitorStatus(spreadsheet) {
  const sheet = getOrCreateMonitorSheet(spreadsheet);
  const lastRow = sheet.getLastRow();
  const status = {};
  
  if (lastRow > 1) {
    const data = sheet.getRange(2, 1, lastRow - 1, 6).getValues();
    data.forEach(row => {
      if (row[0]) {
        status[row[0]] = {
          lastNotified: row[1],
          status: row[2],
          lastDataReceived: row[3],
          notificationCount: row[4] || 0,
          firstLostTime: row[5]
        };
      }
    });
  }
  
  return status;
}

/**
 * Áõ£Ë¶ñÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
 */
function updateMonitorStatus(spreadsheet, status) {
  const sheet = getOrCreateMonitorSheet(spreadsheet);
  
  // Êó¢Â≠ò„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
  if (sheet.getLastRow() > 1) {
    sheet.deleteRows(2, sheet.getLastRow() - 1);
  }
  
  // Êñ∞Ë¶è„Éá„Éº„Çø„ÇíÊõ∏„ÅçËæº„Åø
  const data = [];
  Object.keys(status).forEach(machineId => {
    const s = status[machineId];
    data.push([
      machineId,
      s.lastNotified,
      s.status,
      s.lastDataReceived,
      s.notificationCount || 0,
      s.firstLostTime
    ]);
  });
  
  if (data.length > 0) {
    sheet.getRange(2, 1, data.length, 6).setValues(data);
  }
}
```

## 3. „Éà„É™„Ç¨„ÉºË®≠ÂÆö

### 3.1 ÊôÇÈñì‰∏ªÂ∞éÂûã„Éà„É™„Ç¨„Éº
```javascript
function setupTriggers() {
  // Êó¢Â≠ò„ÅÆ„Éà„É™„Ç¨„Éº„ÇíÂâäÈô§
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'checkMachineSignals') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // Êñ∞Ë¶è„Éà„É™„Ç¨„Éº„ÇíË®≠ÂÆöÔºà1ÂàÜÊØéÔºâ
  ScriptApp.newTrigger('checkMachineSignals')
    .timeBased()
    .everyMinutes(CONFIG.CHECK_INTERVAL_MINUTES)
    .create();
}
```

### 3.2 ÂàùÊúüË®≠ÂÆöÈñ¢Êï∞
```javascript
function initialSetup() {
  // „Çπ„ÇØ„É™„Éó„Éà„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆË®≠ÂÆö
  const properties = {
    'DISCORD_WEBHOOK_URL': '', // Ë¶ÅË®≠ÂÆö
    'TIMEOUT_MINUTES': '10',
    'CHECK_INTERVAL_MINUTES': '1',
    'REMINDER_INTERVAL_MINUTES': '10',
    'ENABLE_NOTIFICATIONS': 'true'
  };
  
  Object.keys(properties).forEach(key => {
    if (!getScriptProperty(key)) {
      setScriptProperty(key, properties[key]);
    }
  });
  
  // „Éà„É™„Ç¨„Éº„ÅÆË®≠ÂÆö
  setupTriggers();
  
  // Áõ£Ë¶ñÁä∂ÊÖã„Ç∑„Éº„Éà„ÅÆ‰ΩúÊàê
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  getOrCreateMonitorSheet(spreadsheet);
}
```

## 4. „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞

### 4.1 „Ç®„É©„ÉºÁ®ÆÂà•„Å®ÂØæÂøú
- **WebHookÈÄÅ‰ø°„Ç®„É©„Éº**: 3Âõû„Åæ„ÅßËá™Âãï„É™„Éà„É©„Ç§
- **„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàË™≠„ÅøÂèñ„Çä„Ç®„É©„Éº**: „Ç®„É©„Éº„É≠„Ç∞„Å´Ë®òÈå≤„Åó„Å¶Ê¨°„ÅÆÊ©ü‰Ωì„ÇíÂá¶ÁêÜ
- **„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Ç®„É©„Éº**: Google Apps Script„ÅÆ6ÂàÜÂà∂Èôê„Å´ÈÖçÊÖÆ„Åó„ÅüÂá¶ÁêÜ

### 4.2 „É≠„Ç∞ÁÆ°ÁêÜ
```javascript
function logError(context, error) {
  console.error(`[${context}] ${error.toString()}`);
  
  // Record error to log sheet (optional)
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let logSheet = spreadsheet.getSheetByName('_ErrorLog');
    if (!logSheet) {
      logSheet = spreadsheet.insertSheet('_ErrorLog');
      logSheet.getRange(1, 1, 1, 3).setValues([['Timestamp', 'Context', 'Error']]);
    }
    
    logSheet.appendRow([
      new Date(),
      context,
      error.toString()
    ]);
  } catch (logError) {
    console.error('Error logging failed:', logError);
  }
}
```

## 5. „Çª„Ç≠„É•„É™„ÉÜ„Ç£ËÄÉÊÖÆ‰∫ãÈ†Ö

### 5.1 WebHook URL‰øùË≠∑
- „Çπ„ÇØ„É™„Éó„Éà„Éó„É≠„Éë„ÉÜ„Ç£„Å´‰øùÂ≠òÔºà„Ç≥„Éº„ÉâÂÜÖ„Å´„Éè„Éº„Éâ„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Åó„Å™„ÅÑÔºâ
- Áí∞Â¢ÉÂ§âÊï∞ÁöÑ„Å™Êâ±„ÅÑ„Åß„Ç¢„ÇØ„Çª„ÇπÂà∂Èôê

### 5.2 Ê®©ÈôêÁÆ°ÁêÜ
- Ê©ü‰Ωì„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÂ§âÊõ¥„ÅØÊâãÂãï„ÅÆ„Åø
- WebHook URLÂ§âÊõ¥„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„Åø

## 6. „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊúÄÈÅ©Âåñ

### 6.1 Âá¶ÁêÜÂäπÁéáÂåñ
- „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Ê©ü‰Ωì„ÅÆ„Åø„ÇíÁõ£Ë¶ñÂØæË±°„Å®„Åô„Çã„Åì„Å®„ÅßÂá¶ÁêÜÈáèÂâäÊ∏õ
- „Éê„ÉÉ„ÉÅÂá¶ÁêÜ„ÅßË§áÊï∞Ê©ü‰Ωì„ÇíÂäπÁéáÁöÑ„Å´Âá¶ÁêÜ

### 6.2 ÂÆüË°åÊôÇÈñìÂØæÁ≠ñ
```javascript
function checkMachineSignalsWithTimeout() {
  const startTime = new Date();
  const MAX_EXECUTION_TIME = 5 * 60 * 1000; // 5 minutes (safety margin for 6-minute limit)
  
  // Processing...
  
  // Check execution time
  if (new Date() - startTime > MAX_EXECUTION_TIME) {
    console.log('Approaching execution time limit, terminating process');
    return;
  }
}
```

## 7. „ÉÜ„Çπ„ÉàË®àÁîª

### 7.1 Âçò‰Ωì„ÉÜ„Çπ„Éà
```javascript
function testDiscordNotification() {
  const testMachine = {
    machineId: 'TEST001',
    lastDataTime: new Date(Date.now() - 11 * 60 * 1000), // 11 minutes ago
    lastData: [
      new Date(), '2025/07/24 10:00:00', 'TEST001', 'TEST',
      35.681236, 139.767125, 100, 12, 3.7, 'Test notification'
    ]
  };
  
  sendLostNotification(testMachine);
}

function testMachineMonitoring() {
  // Execute timeout check for specific machine
  checkMachineSignals();
}
```

### 7.2 Áµ±Âêà„ÉÜ„Çπ„Éà
- ÂÆüÈöõ„ÅÆÊ©ü‰Ωì„Éá„Éº„Çø„Åß„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÊ§úÂá∫„ÉÜ„Çπ„Éà
- DiscordÈÄöÁü•„ÅÆÈÄÅÂèó‰ø°Á¢∫Ë™ç
- Âæ©Â∏∞ÈÄöÁü•„ÅÆ„ÉÜ„Çπ„Éà

## 8. ÈÅãÁî®ÊâãÈ†Ü

### 8.1 ÂàùÊúüË®≠ÂÆö
1. Google Apps Script„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅßË§áÊï∞„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
2. ÂêÑ„Éï„Ç°„Ç§„É´„Å´„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº
3. „Çπ„ÇØ„É™„Éó„Éà„Éó„É≠„Éë„ÉÜ„Ç£„Å´Discord WebHook URL„ÇíË®≠ÂÆö
4. `initialSetup()`„ÇíÂÆüË°å
5. Êó¢Â≠ò„ÅÆÊ©ü‰Ωì„Ç∑„Éº„Éà„ÅÆKÂàó„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Éï„É©„Ç∞„ÇíË®≠ÂÆö

### 8.2 Êó•Â∏∏ÈÅãÁî®
- Ê©ü‰Ωì„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ/Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÅÆÂàá„ÇäÊõø„Åà„ÅØÂêÑ„Ç∑„Éº„Éà„ÅÆKÂàó„ÅßÂÆüÊñΩ
- ÈÄöÁü•Â±•Ê≠¥„ÅØ`_MachineMonitorStatus`„Ç∑„Éº„Éà„ÅßÁ¢∫Ë™ç
- „Ç®„É©„Éº„ÅØ`_ErrorLog`„Ç∑„Éº„Éà„ÅßÁ¢∫Ë™ç

### 8.3 „Éà„É©„Éñ„É´„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞
- ÈÄöÁü•„ÅåÊù•„Å™„ÅÑÂ†¥ÂêàÔºö
  1. „Çπ„ÇØ„É™„Éó„Éà„Éó„É≠„Éë„ÉÜ„Ç£„ÅÆWebHook URLÁ¢∫Ë™ç
  2. „Éà„É™„Ç¨„Éº„ÅÆÂÆüË°åÁä∂Ê≥ÅÁ¢∫Ë™ç
  3. „Ç®„É©„Éº„É≠„Ç∞Á¢∫Ë™ç
- ÈáçË§áÈÄöÁü•„ÅÆÂ†¥ÂêàÔºö
  1. `_MachineMonitorStatus`„Ç∑„Éº„Éà„ÅÆÁä∂ÊÖãÁ¢∫Ë™ç
  2. ÂøÖË¶Å„Å´Âøú„Åò„Å¶Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà