# WebHook信号ロスト通知機能 要件定義書

## 1. 機能概要

機体追跡システムにおいて、機体からのデータ送信が一定時間途絶えた場合に、WebHookを通じて外部システムへ通知を送信する機能を実装する。

## 2. 目的と背景

### 目的
- 機体の通信異常を迅速に検知し、オペレーターへ通知する
- 機体の安全性確保と運用効率の向上

### 背景
- 現在、機体からのデータ送信が途絶えても、能動的に確認しない限り検知できない
- 通信ロストの早期発見により、機体の異常や事故の早期対応が可能となる

## 3. 機能要件

### 3.1 機体アクティブ状態管理
- 各機体シートの1行目K列（K1セル）に「アクティブ状態」フラグを設置
- アクティブ状態は手動で設定可能（TRUE/FALSE、チェックボックス形式）
- 1行目のみで機体の現在状態を表現し、管理を簡素化
- アクティブ状態の機体のみが通知対象となる

### 3.2 信号ロスト検知
- 最後のデータ受信から10分経過後に信号ロストと判定
- チェック間隔：1分毎（Google Apps Scriptのトリガーで実装）

### 3.3 WebHook通知
- 信号ロスト検知時、指定されたWebHook URLへPOST通知を送信
- 通知言語：英語
- 通知内容：
  - 機体ID
  - 最終データ受信時刻
  - ロスト検知時刻
  - 機体の最終位置情報（緯度・経度）

### 3.4 通知管理
- 信号ロスト検知時に1回のみ通知を送信
- 通信復帰時に復帰通知を送信
- 通知の種類：初回ロスト通知、復帰通知（リマインダー通知は廃止）

## 4. 非機能要件

### 4.1 性能要件
- 監視対象機体数：最大100機体
- 通知遅延：ロスト検知から1分以内

### 4.2 可用性要件
- Google Apps Scriptの制限内で動作
- 日次実行時間制限：6時間以内

### 4.3 運用要件
- WebHook URLはスクリプトプロパティで管理
- 通知ログの保存（最新100件）
- システムログ・通知メッセージは英語で統一

## 5. 制約事項

### 5.1 技術的制約
- Google Apps Scriptの実行時間制限（6分/実行）
- トリガー実行間隔の最小値は1分
- 外部HTTPリクエストの日次制限

### 5.2 運用上の制約
- WebHook受信側システムの可用性に依存
- Google Sheetsの行数制限（1000万セル）

## 6. 用語定義

| 用語 | 定義 |
|------|------|
| 機体 | データを送信するIoTデバイス（MachineID で識別） |
| 信号ロスト | 機体からのデータ送信が10分以上途絶えた状態 |
| アクティブ状態 | 監視対象として設定された機体の状態 |
| WebHook | HTTPを介してイベント通知を行う仕組み |

## 7. インターフェース仕様

### 7.1 WebHook通知フォーマット
```json
{
  "event": "signal_lost" | "signal_recovered",
  "machine_id": "00453",
  "last_data_received": "2025-07-24T10:30:00.000Z",
  "detected_at": "2025-07-24T10:40:00.000Z",
  "lost_duration_minutes": 20,
  "notification_count": 2,
  "last_position": {
    "latitude": 34.124125,
    "longitude": 153.131241,
    "altitude": 342.5
  },
  "battery": 3.45,
  "comment": "最後のコメント内容"
}
```

### 7.2 設定項目
- WEBHOOK_URL: 通知先のWebHook URL
- CHECK_INTERVAL_MINUTES: チェック間隔（デフォルト：1分）
- TIMEOUT_MINUTES: タイムアウト時間（デフォルト：10分）
- REMINDER_INTERVAL_MINUTES: （廃止）リマインダー通知は送信されません

## 8. 実装優先度

1. **高**：基本的な信号ロスト検知とWebHook通知
2. **高**：復帰通知
3. **中**：通知ログ機能

## 9. 今後の拡張案

- 機体ごとのタイムアウト時間設定
- 複数のWebHook URL対応
- 通知条件のカスタマイズ（バッテリー低下など）
- Slack、Email等の他の通知手段への対応